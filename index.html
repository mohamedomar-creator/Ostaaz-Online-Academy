<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ostaaz Online Academy | أكاديمية أستاذ أونلاين</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="app" class="app">
    <header class="topbar">
      <div class="brand">
        <div class="logo">OA</div>
        <div class="brand-text">
          <div class="name">Ostaaz Online Academy | أكاديمية أستاذ أونلاين</div>
          <div class="tagline" id="ui_tagline">منصة دروس خصوصية - تجربة تجريبية</div>
        </div>
      </div>

      <div class="top-actions">
        <div class="lang-switch">
          <button id="btn_ar" class="lang-btn">عربي</button>
          <button id="btn_en" class="lang-btn">EN</button>
        </div>

        <select id="roleSwitch" class="role-select" title="Choose role">
          <option value="student">طالب / Student</option>
          <option value="parent">ولي أمر / Parent</option>
          <option value="teacher">مدرس / Teacher</option>
          <option value="admin">Admin</option>
        </select>

        <button id="btnExport" class="btn ghost">Export JSON</button>
        <input id="fileImport" type="file" accept=".json" style="display:none"/>
        <button id="btnImport" class="btn ghost">Import</button>
      </div>
    </header>

    <main class="container">
      <!-- LEFT: Filters & Teachers -->
      <aside class="sidebar">
        <section class="panel">
          <h3 id="ui_filters">Student & Filters</h3>
          <div class="form-row">
            <label id="lbl_grade">Grade / Year</label>
            <select id="gradeSelect">
              <option value="1">Year 1</option>
              <option value="2">Year 2</option>
              <option value="3">Year 3</option>
              <option value="4">Year 4</option>
            </select>
          </div>

          <div class="form-row">
            <label id="lbl_subject">Subject</label>
            <select id="subjectSelect">
              <option value="Math">Math</option>
              <option value="Physics">Physics</option>
              <option value="Chemistry">Chemistry</option>
              <option value="Biology">Biology</option>
            </select>
          </div>

          <div class="form-row">
            <label id="lbl_gender">Preferred teacher gender</label>
            <select id="genderSelect">
              <option value="">Any</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
          </div>

          <div class="form-row">
            <label id="lbl_search">Search</label>
            <input id="searchInput" placeholder="Search by teacher or subject"/>
          </div>

          <div class="form-row actions-row">
            <button id="btnApply" class="btn">Apply</button>
            <button id="btnClear" class="btn ghost">Clear</button>
            <button id="btnDemo" class="btn secondary">Load Demo</button>
          </div>
        </section>

        <section class="panel">
          <h3 id="ui_teachers">Available Teachers</h3>
          <div id="teachersList" class="list"></div>
        </section>

        <section class="panel">
          <h3 id="ui_notifs">Notifications</h3>
          <div id="notifList" class="tiny muted log"></div>
        </section>
      </aside>

      <!-- RIGHT: Main area -->
      <section class="main">
        <!-- Metrics -->
        <div class="metrics">
          <div class="metric card">
            <div class="metric-title" id="ui_metric_students">Students</div>
            <div class="metric-value" id="metricStudents">0</div>
          </div>
          <div class="metric card">
            <div class="metric-title" id="ui_metric_bookings">Bookings</div>
            <div class="metric-value" id="metricBookings">0</div>
          </div>
          <div class="metric card">
            <div class="metric-title" id="ui_metric_revenue">Revenue</div>
            <div class="metric-value" id="metricRevenue">0</div>
          </div>
        </div>

        <!-- Selected Teacher / Availability -->
        <div class="panel">
          <div class="panel-header">
            <h3 id="ui_selected">Selected Teacher</h3>
            <div class="panel-actions">
              <button id="btnFav" class="btn ghost">★ Favorite</button>
            </div>
          </div>

          <div id="selectedCard" class="selected-card">
            <div id="selName" class="sel-name">—</div>
            <div id="selMeta" class="sel-meta small muted">—</div>
            <div id="selDesc" class="small muted" style="margin-top:6px;">—</div>

            <hr />

            <div id="availabilityArea">
              <div class="small muted" id="ui_avail">Availability (pick slots)</div>
              <div id="availabilityGrid" class="availability-grid"></div>
              <div style="margin-top:12px">
                <button id="btnConfirm" class="btn">Confirm selection</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Bookings table -->
        <div class="panel">
          <h3 id="ui_bookings">Bookings / Schedule</h3>
          <div class="table-wrap">
            <table id="bookingsTable">
              <thead>
                <tr>
                  <th id="th_student">Student</th>
                  <th id="th_teacher">Teacher</th>
                  <th id="th_when">When</th>
                  <th id="th_duration">Duration</th>
                  <th id="th_status">Status</th>
                  <th id="th_zoom">Zoom</th>
                  <th id="th_attend">Attend</th>
                </tr>
              </thead>
              <tbody id="bookingsBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Bottom: summaries and teacher controls -->
        <div class="panel flex-between">
          <div>
            <h4 id="ui_summary">Monthly Summary</h4>
            <div class="small muted">
              Attended: <strong id="sum_attended">0</strong> • Missed: <strong id="sum_missed">0</strong> • Total: <strong id="sum_total">0</strong>
            </div>
          </div>

          <div id="teacherControls" class="teacher-controls">
            <h4 id="ui_teacher_controls">Teacher Controls</h4>
            <label>Hourly rate</label>
            <input id="teacherRate" placeholder="e.g. 30"/>
            <label>Availability (e.g. Mon:09-12,Wed:15-18)</label>
            <input id="teacherAvail" placeholder="Mon:09-12,Wed:15-18"/>
            <div style="margin-top:8px">
              <button id="saveTeacher" class="btn">Save</button>
              <button id="clearTeacher" class="btn ghost">Clear</button>
            </div>
          </div>
        </div>

      </section>
    </main>

    <footer class="footer">
      <div>© <span id="ui_footer">Ostaaz Online Academy | أكاديمية أستاذ أونلاين</span> — Demo</div>
      <div class="footer-actions">
        <button id="btnExportSmall" class="btn ghost">Export</button>
      </div>
    </footer>
  </div>

  <script src="script.js"></script>
</body>
</html>
:root{
  --bg:#f4f6f9; --card:#fff; --accent:#0b66ff; --accent-dark:#054bb8;
  --muted:#6b7280; --success:#16a34a; --danger:#ef4444;
  --glass: rgba(255,255,255,0.85);
}
*{box-sizing:border-box}
html[lang="ar"]{ direction:rtl }
html[lang="en"]{ direction:ltr }
body{
  margin:0; font-family:Inter, "Segoe UI", Tahoma, Roboto, "Noto Sans", sans-serif;
  background:linear-gradient(180deg,#eef6ff, var(--bg));
  color:#0f172a;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
.app{ max-width:1200px; margin:20px auto; padding:12px; }

/* topbar */
.topbar{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  background:var(--card); padding:12px 16px; border-radius:12px; box-shadow:0 6px 18px rgba(2,6,23,0.06);
}
.brand{ display:flex; gap:12px; align-items:center; }
.logo{ width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#6d28d9);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800 }
.brand-text .name{ font-weight:800 }
.top-actions{ display:flex;align-items:center; gap:8px }
.lang-btn{ background:transparent;border:1px solid rgba(15,23,42,0.06); padding:6px 8px; border-radius:8px; cursor:pointer }
.role-select{ padding:6px 8px;border-radius:8px;border:1px solid #e6e9ef }

/* layout */
.container{ display:grid; grid-template-columns:320px 1fr; gap:16px; margin-top:16px }
@media (max-width:980px){ .container{ grid-template-columns: 1fr; } .sidebar{ order:2 } .main{ order:1 } }

/* sidebar */
.sidebar .panel{ background:var(--card); padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,0.04); margin-bottom:12px }
.form-row{ margin-bottom:8px }
.form-row label{ display:block; font-weight:700; color:var(--muted); margin-bottom:6px }
.form-row input, .form-row select{ width:100%; padding:8px;border-radius:8px;border:1px solid #e6e9ef }

/* teachers list */
.list{ max-height:360px; overflow:auto }
.teacher-item{ display:flex; gap:10px; align-items:center; padding:8px; border-radius:8px; border:1px solid #eef2ff; background:linear-gradient(180deg,#fff,#fbfdff); margin-bottom:8px }
.avatar{ width:44px;height:44px;border-radius:8px;background:#eef2ff;display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--accent) }
.teacher-info .name{ font-weight:700 }
.teacher-meta{ color:var(--muted); font-size:13px }

/* main area */
.main .metrics{ display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap }
.metric{ flex:1; min-width:160px; padding:12px; border-radius:10px; background:var(--card); box-shadow:0 6px 18px rgba(2,6,23,0.04) }
.metric-title{ color:var(--muted); font-weight:700; font-size:13px }
.metric-value{ font-size:20px; font-weight:800; margin-top:6px }

/* selected card and availability */
.selected-card{ padding:12px; border-radius:8px; background:var(--card) }
.sel-name{ font-weight:900; font-size:18px }
.sel-meta{ color:var(--muted) }

.availability-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-top:8px }
.slot{ padding:8px; border-radius:8px; border:1px dashed #e6eefc; text-align:center; cursor:pointer; background:#fff }
.slot.taken{ opacity:0.6; cursor:not-allowed }
.slot.selected{ background:linear-gradient(90deg,var(--accent),var(--accent-dark)); color:#fff; border:0 }

/* table */
.table-wrap{ overflow:auto; max-height:320px }
table{ width:100%; border-collapse:collapse; background:var(--card); border-radius:8px; overflow:hidden }
th, td{ padding:8px 10px; text-align:center; border-bottom:1px solid #f1f5f9 }
th{ background:linear-gradient(90deg,#f8fafc,#fff); color:var(--muted); font-weight:800 }

/* panels */
.panel{ background:var(--card); padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,0.04); margin-bottom:12px }
.panel-header{ display:flex; align-items:center; justify-content:space-between }

/* bottom/footer */
.footer{ margin-top:14px; padding:12px; display:flex; justify-content:space-between; color:var(--muted) }

/* buttons */
.btn{ background:var(--accent); color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700 }
.btn.secondary{ background:#2563eb }
.btn.ghost{ background:transparent; color:var(--muted); border:1px solid rgba(2,6,23,0.06) }

/* small helpers */
.small{ font-size:13px }
.muted{ color:var(--muted) }
.log{ max-height:160px; overflow:auto }
.flex-between{ display:flex; justify-content:space-between; align-items:center }

/* responsive tweaks */
@media (max-width:640px){
  .availability-grid{ grid-template-columns: repeat(4, 1fr) }
  .logo{ width:44px;height:44px }
  .brand-text .name{ font-size:14px }
}
/**
 * Ostaaz Online Academy - Frontend-only demo
 * - Local data in localStorage
 * - Roles: student / parent / teacher / admin
 * - Bilingual (ar / en)
 * - Bookings with fake Zoom links, attendance, notifications (simulated)
 *
 * NOTE: If you merge this with existing HTML you already have, avoid duplicating IDs.
 */

(function(){
  // ---------- Translations ----------
  const TEXT = {
    ar: {
      tagline: "منصة دروس خصوصية - تجربة تجريبية",
      filtersTitle: "معلومات الطالب و الفلاتر",
      teachersTitle: "المدرسين المتاحين",
      notifsTitle: "الإشعارات",
      availTitle: "التوفر (اختر مواعيد)",
      selectedTeacher: "المدرس المختار",
      bookingsTitle: "الحجوزات / الجدول",
      summaryTitle: "ملخص شهري",
      teacherControls: "أدوات المدرس",
      btnApply: "تطبيق",
      btnClear: "مسح",
      btnDemo: "تحميل مثال",
      btnSave: "حفظ",
      btnConfirm: "تأكيد الاختيار",
      noTeachers: "لا يوجد مدرسين مطابقين",
      joinText: "انضم"
    },
    en: {
      tagline: "Private lessons platform - Demo",
      filtersTitle: "Student & Filters",
      teachersTitle: "Available Teachers",
      notifsTitle: "Notifications",
      availTitle: "Availability (pick slots)",
      selectedTeacher: "Selected Teacher",
      bookingsTitle: "Bookings / Schedule",
      summaryTitle: "Monthly Summary",
      teacherControls: "Teacher Controls",
      btnApply: "Apply",
      btnClear: "Clear",
      btnDemo: "Load Demo",
      btnSave: "Save",
      btnConfirm: "Confirm selection",
      noTeachers: "No matching teachers",
      joinText: "Join"
    }
  };

  // current language
  let LANG = localStorage.getItem('ost_lang') || 'ar';
  document.documentElement.lang = LANG === 'ar' ? 'ar' : 'en';

  // ---------- Demo data ----------
  const DEMO = {
    teachers: [
      { id:'t1', name_ar:'د. سارة عبدالله', name_en:'Dr. Sarah Abdullah', gender:'female', subjects:['Math','Physics'], rating:4.9, reviews: ['Patient','Clear explanations'], rate:35, avail:'Mon:09-12,Wed:15-18' },
      { id:'t2', name_ar:'أ. محمد حسن', name_en:'Mohammed Hassan', gender:'male', subjects:['Chemistry'], rating:4.6, reviews:['Explains well'], rate:30, avail:'Tue:10-13,Thu:16-19' },
      { id:'t3', name_ar:'أ. عائشة صالح', name_en:'Aisha Al Saleh', gender:'female', subjects:['Biology','Chemistry'], rating:4.8, reviews:['Very helpful'], rate:40, avail:'Mon:14-17,Fri:09-12' }
    ],
    students: [
      { id:'s1', name:'Ali bin Ahmed', grade:2, parent:'Parent A' },
      { id:'s2', name:'Sara bint Naim', grade:3, parent:'Parent B' }
    ],
    bookings: [],
    notifs: []
  };

  // ---------- localStorage keys ----------
  const LS = {
    teachers: 'ost_teachers',
    students: 'ost_students',
    bookings: 'ost_bookings',
    notifs: 'ost_notifs',
    lang: 'ost_lang'
  };

  // load or init
  let teachers = load(LS.teachers, DEMO.teachers);
  let students = load(LS.students, DEMO.students);
  let bookings = load(LS.bookings, DEMO.bookings);
  let notifs = load(LS.notifs, DEMO.notifs);

  // UI elements
  const el = id => document.getElementById(id);

  // selected & state
  let currentRole = 'student';
  let selectedTeacherId = null;
  let selectedSlots = []; // {teacherId, whenISO, duration, slotId}

  // init on DOM ready
  window.addEventListener('load', init);

  // ---------- utility ----------
  function uid(prefix='id'){ return prefix + Math.random().toString(36).slice(2,9); }
  function save(key, data){ localStorage.setItem(key, JSON.stringify(data)); }
  function load(key, fallback){ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
  function nowISO(){ return new Date().toISOString(); }
  function formatDateISO(iso){
    const d = new Date(iso);
    return d.toLocaleString(LANG==='ar' ? 'ar-EG' : 'en-US', {year:'numeric',month:'short',day:'numeric', hour:'2-digit', minute:'2-digit'});
  }

  // ---------- init ----------
  function init(){
    // language buttons
    el('btn_ar').addEventListener('click', ()=> setLang('ar'));
    el('btn_en').addEventListener('click', ()=> setLang('en'));
    setLang(LANG);

    // role
    el('roleSwitch').addEventListener('change', (e)=> { currentRole=e.target.value; renderAll(); });

    // demo / apply / clear
    el('btnApply').addEventListener('click', renderTeachers);
    el('btnClear').addEventListener('click', clearFilters);
    el('btnDemo').addEventListener('click', loadDemo);

    // export/import
    el('btnExport').addEventListener('click', exportData);
    el('btnExportSmall').addEventListener('click', exportData);
    el('btnImport').addEventListener('click', ()=> el('fileImport').click());
    el('fileImport').addEventListener('change', importData);

    // confirm selection
    el('btnConfirm').addEventListener('click', confirmSelection);

    // save teacher settings (teacher controls)
    el('saveTeacher').addEventListener('click', saveTeacherSettings);
    el('clearTeacher').addEventListener('click', ()=> { el('teacherRate').value=''; el('teacherAvail').value=''; });

    // search input live
    el('searchInput').addEventListener('input', throttle(renderTeachers,300));
    el('gradeSelect').addEventListener('change', renderTeachers);
    el('subjectSelect').addEventListener('change', renderTeachers);
    el('genderSelect').addEventListener('change', renderTeachers);

    // initial render
    renderAll();

    // notification checker - simulate reminders every 30s (for demo)
    setInterval(checkUpcomingBookings, 30 * 1000);
  }

  // ---------- language ----------
  function setLang(lang){
    LANG = lang; localStorage.setItem(LS.lang, lang);
    document.documentElement.lang = LANG==='ar' ? 'ar' : 'en';

    // apply simple texts
    el('ui_tagline').innerText = TEXT[LANG].tagline;
    el('ui_teachers').innerText = TEXT[LANG].teachersTitle;
    el('ui_notifs').innerText = TEXT[LANG].notifsTitle;
    el('ui_avail').innerText = TEXT[LANG].availTitle;
    el('ui_selected').innerText = TEXT[LANG].selectedTeacher;
    el('ui_bookings').innerText = TEXT[LANG].bookingsTitle;
    el('ui_summary').innerText = TEXT[LANG].summaryTitle;
    el('ui_teacher_controls').innerText = TEXT[LANG].teacherControls;
    el('btnDemo').innerText = TEXT[LANG].btnDemo;
    el('btnApply').innerText = TEXT[LANG].btnApply;
    el('btnClear').innerText = TEXT[LANG].btnClear;
    el('btnConfirm').innerText = TEXT[LANG].btnConfirm;
    el('saveTeacher').innerText = TEXT[LANG].btnSave;

    // update student/subject selects for demo readability
    if (LANG==='ar'){
      // nothing major here - the select values remain (subject keys in English for logic)
    }

    renderAll();
  }

  // ---------- render all ----------
  function renderAll(){
    renderTeachers();
    renderSelectedTeacher();
    renderBookingsTable();
    renderNotifs();
    updateMetrics();
    updateSummary();
    updateTeacherControlsVisibility();
  }

  // ---------- filters ----------
  function clearFilters(){
    el('gradeSelect').value='1';
    el('subjectSelect').value='Math';
    el('genderSelect').value='';
    el('searchInput').value='';
    renderTeachers();
  }

  function loadDemo(){
    teachers = DEMO.teachers.slice();
    students = DEMO.students.slice();
    bookings = DEMO.bookings.slice();
    notifs = DEMO.notifs.slice();
    save(LS.teachers, teachers); save(LS.students, students); save(LS.bookings, bookings); save(LS.notifs, notifs);
    pushNotif(LANG==='ar' ? 'تم تحميل بيانات تجريبية' : 'Demo data loaded');
    renderAll();
  }

  // ---------- teachers list ----------
  function renderTeachers(){
    const ct = el('teachersList'); ct.innerHTML = '';
    const q = (el('searchInput').value||'').toLowerCase();
    const gender = el('genderSelect').value;
    const subject = el('subjectSelect').value;

    const filtered = teachers.filter(t=>{
      if (gender && t.gender !== gender) return false;
      if (subject && !(t.subjects||[]).includes(subject)) return false;
      if (q){
        const name = (LANG==='ar' ? (t.name_ar||t.name_en) : t.name_en).toLowerCase();
        if (!name.includes(q) && !(t.subjects||[]).join(' ').toLowerCase().includes(q)) return false;
      }
      return true;
    });

    if (!filtered.length){
      ct.innerHTML = `<div class="muted small">${TEXT[LANG].noTeachers}</div>`;
      return;
    }

    filtered.forEach(t=>{
      const div = document.createElement('div'); div.className='teacher-item';
      const displayName = LANG==='ar' ? (t.name_ar||t.name_en) : (t.name_en||t.name_ar);
      div.innerHTML = `
        <div class="avatar">${displayName.split(' ').slice(0,1)[0].slice(0,1)}</div>
        <div class="teacher-info" style="flex:1">
          <div class="name">${displayName}</div>
          <div class="teacher-meta small muted">${(t.subjects||[]).join(' • ')} • ${t.rate} /hr • ⭐ ${t.rating}</div>
        </div>
        <div>
          <button class="btn select-btn" data-id="${t.id}">${LANG==='ar' ? 'اختر' : 'Select'}</button>
        </div>
      `;
      ct.appendChild(div);
    });

    // attach select handlers
    ct.querySelectorAll('.select-btn').forEach(b=>{
      b.addEventListener('click', e=>{
        selectedTeacherId = e.target.dataset.id;
        selectedSlots = [];
        renderSelectedTeacher();
        pushNotif(LANG==='ar' ? 'تم اختيار مدرس' : 'Teacher selected');
      });
    });
  }

  // ---------- selected teacher & availability ----------
  function renderSelectedTeacher(){
    const selName = el('selName'); const selMeta = el('selMeta'); const selDesc = el('selDesc');
    if (!selectedTeacherId){ selName.innerText='—'; selMeta.innerText='—'; selDesc.innerText='—'; el('availabilityGrid').innerHTML=''; return; }
    const t = teachers.find(x=>x.id===selectedTeacherId);
    if (!t) return;
    const displayName = LANG==='ar' ? (t.name_ar||t.name_en) : (t.name_en||t.name_ar);
    selName.innerText = displayName;
    selMeta.innerText = `${(t.subjects||[]).join(', ')} • ${t.rate} /hr • ⭐ ${t.rating}`;
    selDesc.innerText = (t.reviews && t.reviews.length) ? (LANG==='ar' ? 'المراجعات: ' : 'Reviews: ') + t.reviews.join(' | ') : '';

    renderAvailabilityGrid(t);
  }

  // parse availability "Mon:09-12,Wed:15-18"
  function parseAvail(av){
    const map = {};
    if (!av) return map;
    av.split(',').forEach(part=>{
      const [day, hrs] = part.split(':').map(s=>s.trim());
      if (!day || !hrs) return;
      const [start,end] = hrs.split('-').map(n=>parseInt(n,10));
      map[day.trim().slice(0,3)] = {start,end};
    });
    return map;
  }

  // generate next 7 days slots according to avail
  function renderAvailabilityGrid(teacher){
    const grid = el('availabilityGrid'); grid.innerHTML = '';
    const now = new Date();
    const availMap = parseAvail(teacher.avail || '');
    for(let i=0;i<7;i++){
      const day = new Date(now); day.setDate(now.getDate()+i);
      const dayKey = day.toLocaleDateString('en-US',{weekday:'short'}); // Mon,Tue...
      const column = document.createElement('div');
      column.style.display='flex'; column.style.flexDirection='column'; column.style.gap='6px';

      const header = document.createElement('div'); header.className='small muted'; header.style.textAlign='center';
      header.innerText = `${day.toLocaleDateString(LANG==='ar'?'ar-EG':'en-US',{weekday:'short', day:'numeric', month:'short'})}`;
      column.appendChild(header);

      const a = availMap[dayKey];
      if (!a){
        const no = document.createElement('div'); no.className='small muted'; no.style.textAlign='center'; no.innerText = LANG==='ar' ? 'غير متاح' : 'Not available';
        column.appendChild(no);
      } else {
        for(let h=a.start; h < a.end; h++){
          const slotTime = new Date(day); slotTime.setHours(h,0,0,0);
          const iso = slotTime.toISOString();
          const slot = document.createElement('div'); slot.className='slot';
          slot.dataset.iso = iso;
          slot.innerText = `${h}:00 - ${h+1}:00`;
          // check if already booked
          const taken = bookings.some(b => b.teacherId===teacher.id && new Date(b.when).toISOString() === iso);
          if (taken) { slot.classList.add('taken'); slot.innerText = slot.innerText + ' • ' + (LANG==='ar'?'محجوز':'Booked'); }
          else {
            slot.addEventListener('click', ()=>{
              if (slot.classList.contains('selected')){
                slot.classList.remove('selected');
                selectedSlots = selectedSlots.filter(s=>s.slotId !== `${teacher.id}_${iso}`);
              } else {
                slot.classList.add('selected');
                selectedSlots.push({ teacherId: teacher.id, when: iso, duration: 60, slotId: `${teacher.id}_${iso}`});
              }
            });
          }
          column.appendChild(slot);
        }
      }
      grid.appendChild(column);
    }
  }

  // ---------- bookings ----------
  function confirmSelection(){
    if (!selectedTeacherId){ alert(LANG==='ar'?'اختر مدرسًا أولاً':'Select a teacher first'); return; }
    if (!selectedSlots.length){ alert(LANG==='ar'?'اختر مواعيد أولاً':'Pick some slots first'); return; }
    // for demo, pick first student
    const student = students[0] || { id: uid('s'), name:'Demo Student', grade:1 };
    selectedSlots.forEach(s=>{
      // create booking if not exists
      if (bookings.some(b=>b.teacherId===s.teacherId && b.when === s.when)) return;
      const teacher = teachers.find(t=>t.id===s.teacherId) || {};
      const b = {
        id: uid('b'),
        studentId: student.id,
        studentName: student.name,
        teacherId: s.teacherId,
        teacherName: (LANG==='ar'? (teacher.name_ar||teacher.name_en) : (teacher.name_en||teacher.name_ar)) || teacher.name_en || 'Teacher',
        when: s.when,
        duration: s.duration,
        status: 'Scheduled',
        attended: false,
        price: teacher.rate || 0,
        zoomLink: generateZoomLink()
      };
      bookings.push(b);
      pushNotif(`${LANG==='ar'?'تم حجز حصة مع':'Booking created with'} ${b.teacherName} • ${formatDateISO(b.when)}`);
    });
    save(LS.bookings, bookings);
    selectedSlots = [];
    renderSelectedTeacher(); renderBookingsTable(); updateMetrics(); updateSummary();
  }

  function generateZoomLink(){
    const id = Math.floor(Math.random()*900000000)+100000000;
    return `https://zoom.us/j/${id}`;
  }

  // render bookings table
  function renderBookingsTable(){
    const tbody = el('bookingsBody'); tbody.innerHTML = '';
    // show most recent first
    bookings.slice().reverse().forEach(b=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHTML(b.studentName)}</td>
        <td>${escapeHTML(b.teacherName)}</td>
        <td>${formatDateISO(b.when)}</td>
        <td>${b.duration} min</td>
        <td><span class="badge ${b.status==='Completed'?'green':''}">${b.status}</span></td>
        <td><a href="${b.zoomLink}" target="_blank">${TEXT[LANG].joinText}</a></td>
        <td><button class="btn attend-btn" data-id="${b.id}">${b.attended ? (LANG==='ar'?'حاضر':'Present') : (LANG==='ar'?'تسجيل حضور':'Mark')}</button></td>
      `;
      tbody.appendChild(tr);
    });
    // attach attend handlers
    tbody.querySelectorAll('.attend-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const id = e.target.dataset.id;
        const idx = bookings.findIndex(x=>x.id===id);
        if (idx>-1){
          bookings[idx].attended = !bookings[idx].attended;
          bookings[idx].status = bookings[idx].attended ? 'Completed' : 'Scheduled';
          save(LS.bookings, bookings);
          renderBookingsTable(); updateSummary();
          pushNotif(LANG==='ar'?'تحديث الحضور':'Attendance updated');
        }
      });
    });
  }

  // ---------- notifications ----------
  function pushNotif(text){
    const n = { id: uid('n'), text, time: nowISO() };
    notifs.unshift(n);
    if (notifs.length>200) notifs.pop();
    save(LS.notifs, notifs);
    renderNotifs();
  }
  function renderNotifs(){
    const eln = el('notifList'); eln.innerHTML = '';
    notifs.slice(0,50).forEach(n=>{
      const d = document.createElement('div'); d.className='tiny muted'; d.style.marginBottom='8px';
      d.innerHTML = `<div style="font-weight:700">${formatDateISO(n.time)}</div><div>${escapeHTML(n.text)}</div>`;
      eln.appendChild(d);
    });
  }
  // check upcoming bookings within next X minutes and notify (simulate)
  function checkUpcomingBookings(){
    const now = new Date();
    bookings.forEach(b=>{
      const when = new Date(b.when);
      const diffMin = (when - now) / (60*1000);
      // notify 60min and 10min before (demo conditions)
      if (diffMin > 0 && diffMin < 61 && !b._notified60){
        pushNotif((LANG==='ar'?'تذكير: حصة بعد ساعة مع ':'Reminder: lesson in 60min with ') + b.teacherName);
        b._notified60 = true;
      }
      if (diffMin > 0 && diffMin < 11 && !b._notified10){
        pushNotif((LANG==='ar'?'تذكير: حصة بعد 10 دقائق مع ':'Reminder: lesson in 10min with ') + b.teacherName);
        b._notified10 = true;
      }
    });
  }

  // ---------- metrics & summary ----------
  function updateMetrics(){
    el('metricStudents').innerText = students.length;
    el('metricBookings').innerText = bookings.length;
    const revenue = bookings.reduce((s,b)=> s + (b.price||0), 0);
    el('metricRevenue').innerText = revenue;
  }
  function updateSummary(){
    const thisMonth = (new Date()).getMonth();
    const m = bookings.filter(b => new Date(b.when).getMonth()===thisMonth);
    const attended = m.filter(x=>x.attended).length;
    const missed = m.filter(x=> !x.attended && new Date(x.when) < new Date()).length;
    const total = m.reduce((s,x)=> s + (x.price||0), 0);
    el('sum_attended').innerText = attended;
    el('sum_missed').innerText = missed;
    el('sum_total').innerText = total;
  }

  // ---------- teacher controls ----------
  function updateTeacherControlsVisibility(){
    const panel = el('teacherControls');
    panel.style.display = currentRole==='teacher' ? 'block' : 'none';
    // fill values for first teacher as example
    if (currentRole==='teacher' && teachers[0]){
      el('teacherRate').value = teachers[0].rate || '';
      el('teacherAvail').value = teachers[0].avail || '';
    }
  }
  function saveTeacherSettings(){
    if (currentRole!=='teacher'){ alert(LANG==='ar'?'الرجاء اختيار دور المدرس لحفظ':'Switch to teacher role to save'); return; }
    // edit first teacher (demo)
    const t = teachers[0];
    if (!t) return;
    const rate = el('teacherRate').value.trim();
    const avail = el('teacherAvail').value.trim();
    if (rate) t.rate = parseFloat(rate);
    if (avail) t.avail = avail;
    save(LS.teachers, teachers);
    pushNotif(LANG==='ar'?'تم حفظ إعدادات المدرس':'Teacher settings saved');
    renderTeachers(); renderSelectedTeacher();
  }

  // ---------- export / import ----------
  function exportData(){
    const dump = { teachers, students, bookings, notifs };
    const blob = new Blob([JSON.stringify(dump,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ost_data.json';
    a.click();
  }
  function importData(e){
    const f = e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = function(ev){
      try {
        const obj = JSON.parse(ev.target.result);
        if (obj.teachers) teachers = obj.teachers;
        if (obj.students) students = obj.students;
        if (obj.bookings) bookings = obj.bookings;
        if (obj.notifs) notifs = obj.notifs;
        save(LS.teachers, teachers); save(LS.students, students); save(LS.bookings, bookings); save(LS.notifs, notifs);
        pushNotif(LANG==='ar'?'تم استيراد البيانات':'Data imported');
        renderAll();
      } catch(err){ alert('Invalid JSON'); }
    };
    reader.readAsText(f);
  }

  // ---------- helpers ----------
  function escapeHTML(s){ return (s||'').toString().replace(/[&<>"'`]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[c])); }
  function throttle(fn, wait){ let t; return function(...a){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), wait) } }

  // initial render call
  function renderNotifs(){ renderNotifs = renderNotifsInner; /* placeholder */ }
  function renderNotifsInner(){ const eln = el('notifList'); eln.innerHTML=''; notifs.forEach(n=>{ const d=document.createElement('div'); d.className='tiny muted'; d.style.marginBottom='8px'; d.innerHTML = `<div style="font-weight:700">${formatDateISO(n.time)}</div><div>${escapeHTML(n.text)}</div>`; eln.appendChild(d); }); }
  renderNotifs = renderNotifsInner;

  // expose render functions used earlier
  window.renderAll = renderAll;
  window.renderTeachers = renderTeachers;
  window.renderSelectedTeacher = renderSelectedTeacher;
  window.renderBookingsTable = renderBookingsTable;

  // save initial datasets if not exist
  if (!localStorage.getItem(LS.teachers)) save(LS.teachers, teachers);
  if (!localStorage.getItem(LS.students)) save(LS.students, students);
  if (!localStorage.getItem(LS.bookings)) save(LS.bookings, bookings);
  if (!localStorage.getItem(LS.notifs)) save(LS.notifs, notifs);

})();

