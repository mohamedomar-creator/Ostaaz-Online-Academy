<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Academy Scheduler — أستاذ أونلاين</title>

  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ====== BASIC STYLES (RTL + LTR supported) ====== */
    :root{
      --bg:#f4f6f8; --card:#fff; --accent:#0b66ff; --success:#16a34a; --warning:#f59e0b; --danger:#ef4444;
      --muted:#6b7280; --glass: rgba(255,255,255,0.85);
    }
    html[lang="en"]{ direction:ltr; }
    html[lang="ar"]{ direction:rtl; }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", "Cairo", sans-serif;
      background: linear-gradient(180deg,#eaf2ff 0%, var(--bg) 45%);
      color:#0f172a; -webkit-font-smoothing:antialiased;
    }
    .app {
      max-width:1100px; margin:32px auto; padding:20px;
    }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:18px;
    }
    .brand { display:flex; gap:12px; align-items:center; }
    .logo {
      width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#6d28d9);
      display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:18px;
    }
    .title { font-size:20px; font-weight:700; }
    .sub { color:var(--muted); font-size:13px; }

    .controls { display:flex; gap:8px; align-items:center; }

    button, .btn {
      background:var(--accent); color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700;
    }
    .btn.secondary { background:#334155; }
    .btn.ghost { background:transparent; color:var(--muted); border:1px solid rgba(15,23,42,0.06) }

    /* layout */
    .grid { display:grid; gap:16px; grid-template-columns: 320px 1fr; }
    @media (max-width:900px){ .grid{ grid-template-columns: 1fr; } header{flex-direction:column;align-items:flex-start} }

    /* left panel (filters/user) */
    .panel { background:var(--card); border-radius:12px; padding:16px; box-shadow:0 6px 18px rgba(2,6,23,0.06); }
    .section-title { font-weight:700; margin-bottom:8px; }
    label{display:block;font-size:13px;color:var(--muted); margin-bottom:6px}
    select,input[type="text"],input[type="date"]{
      width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px;margin-bottom:10px;
      background:transparent;
    }
    .filters { display:flex; flex-direction:column; gap:8px; }

    /* teacher list card */
    .teacher {
      display:flex; gap:12px; align-items:center; padding:10px; border-radius:10px; background:linear-gradient(180deg,#fff,#fbfdff);
      border:1px solid #eef2ff; margin-bottom:10px;
    }
    .avatar { width:56px;height:56px;border-radius:10px;background:#eef2ff; display:flex;align-items:center;justify-content:center;font-weight:800; color:#0b66ff}
    .t-info { flex:1 }
    .t-name { font-weight:700; }
    .t-meta { font-size:13px;color:var(--muted) }
    .rating { font-weight:700;color:var(--accent); }

    .teacher .actions { display:flex; gap:8px; }

    /* main area: schedule, charts, table */
    .main-grid { display:grid; gap:12px; grid-template-columns: 1fr; }
    .cards { display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
    .card { background:var(--card); padding:14px; border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,0.04); min-width:160px; flex:1; }
    .metric { font-size:22px; font-weight:800; }
    .small { font-size:13px; color:var(--muted) }

    /* availability grid */
    .availability { display:grid; grid-template-columns: repeat(7,1fr); gap:6px; }
    .slot { background:#fff; padding:8px; border-radius:8px; border:1px dashed #e6eefc; font-size:13px; text-align:center; cursor:pointer; }
    .slot.taken { background:#f8fafc; color:var(--muted); cursor:not-allowed; opacity:0.7 }
    .slot.selected { background:linear-gradient(90deg,var(--accent),#6d28d9); color:#fff; border:0; }

    /* bookings table */
    table { width:100%; border-collapse:collapse; background:var(--card); border-radius:10px; overflow:hidden; box-shadow:0 6px 20px rgba(2,6,23,0.04) }
    th,td { padding:10px; text-align:center; border-bottom:1px solid #f1f5f9; font-size:14px; }
    th { background:linear-gradient(90deg,#f8fafc,#fff); color:var(--muted); font-weight:700; }

    .tiny { font-size:12px;color:var(--muted) }

    /* badges */
    .badge { padding:6px 8px; border-radius:999px; background:#eef2ff; color:var(--accent); font-weight:700; font-size:13px; display:inline-block; }
    .badge.green{ background:rgba(16,163,127,0.12); color:var(--success) }
    .badge.red{ background:rgba(239,68,68,0.08); color:var(--danger) }

    /* language toggle */
    .lang-toggle { display:flex; gap:6px; align-items:center; }
    .lang-toggle button{ padding:6px 8px; border-radius:8px; font-weight:700 }

    /* small helpers */
    .muted { color:var(--muted) }
    .flex { display:flex; gap:8px; align-items:center }
    .center { text-align:center }
    .mt8{ margin-top:8px } .mb8{ margin-bottom:8px }

    footer{ text-align:center; margin-top:18px; color:var(--muted); font-size:13px }
  </style>
</head>

<body>
  <div class="app" id="app">
    <header>
      <div class="brand">
        <div class="logo">A</div>
        <div>
          <div class="title" id="ui_title">أكاديمية أستاذ أونلاين</div>
          <div class="sub" id="ui_sub">حجز دروس خصوصية بسهولة — تجربة تجريبية</div>
        </div>
      </div>

      <div class="controls">
        <div class="lang-toggle" aria-hidden>
          <button id="btn_ar" class="btn ghost">عربي</button>
          <button id="btn_en" class="btn ghost">EN</button>
        </div>
        <select id="roleSelect" style="padding:8px;border-radius:8px">
          <option value="student">طالب</option>
          <option value="parent">ولي أمر</option>
          <option value="teacher">مدرس</option>
          <option value="admin">Admin</option>
        </select>
        <button id="demoFill" class="btn secondary">Load Demo</button>
        <button id="exportBtn" class="btn">Export Data</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT PANEL: filters + teachers -->
      <aside>
        <div class="panel">
          <div class="section-title" id="ui_filters_title">علومات الطالب و الفلاتر</div>

          <div class="filters">
            <label id="ui_label_grade">الصف الدراسي / Year</label>
            <select id="gradeSelect">
              <option value="1">Year 1</option>
              <option value="2">Year 2</option>
              <option value="3">Year 3</option>
              <option value="4">Year 4</option>
            </select>

            <label id="ui_label_gender">Preferred teacher gender</label>
            <select id="genderPref">
              <option value="">Any</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>

            <label id="ui_label_search">Search student / teacher</label>
            <input id="searchBox" type="text" placeholder="Search by name..." />

            <label id="ui_label_status">Status (show)</label>
            <select id="statusFilter">
              <option value="">All</option>
              <option value="Completed">Completed</option>
              <option value="In Progress">In Progress</option>
              <option value="Pending">Pending</option>
            </select>

            <div class="mt8 center">
              <button id="applyFilters" class="btn">Apply Filters</button>
              <button id="clearFilters" class="btn ghost">Clear</button>
            </div>
          </div>
        </div>

        <div class="panel mt8">
          <div class="section-title" id="ui_teachers">Available Teachers</div>
          <div id="teachersList" style="margin-top:8px; max-height:420px; overflow:auto"></div>
        </div>

        <div class="panel mt8">
          <div class="section-title" id="ui_notifications">Notifications Log</div>
          <div id="notifLog" style="margin-top:8px; max-height:160px; overflow:auto; font-size:13px" class="tiny muted"></div>
        </div>
      </aside>

      <!-- RIGHT (main) -->
      <main>
        <div class="main-grid">
          <!-- top metrics -->
          <div class="cards">
            <div class="card">
              <div class="small" id="ui_metric_students">Students</div>
              <div class="metric" id="metric_students">0</div>
              <div class="tiny muted">Total registered students</div>
            </div>
            <div class="card">
              <div class="small" id="ui_metric_bookings">Bookings</div>
              <div class="metric" id="metric_bookings">0</div>
              <div class="tiny muted">Active bookings</div>
            </div>
            <div class="card">
              <div class="small" id="ui_metric_revenue">Revenue</div>
              <div class="metric" id="metric_revenue">0</div>
              <div class="tiny muted">Experimental currency</div>
            </div>
          </div>

          <!-- teacher profile + availability -->
          <div class="card" id="teacherProfileCard">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="section-title" id="ui_selected_teacher">Selected Teacher</div>
                <div id="selectedTeacherName" class="t-name">—</div>
                <div id="selectedTeacherMeta" class="t-meta tiny">—</div>
              </div>
              <div class="flex">
                <button id="bookBtn" class="btn">Book Selected</button>
                <button id="favBtn" class="btn ghost">Favourite</button>
              </div>
            </div>

            <hr style="margin:12px 0">

            <div>
              <div class="small" id="ui_avail_title">Availability (pick slots)</div>
              <div class="availability mt8" id="availabilityGrid">
                <!-- generated slots -->
              </div>
              <div class="mt8 center">
                <button id="confirmSlots" class="btn">Confirm Selection</button>
              </div>
            </div>
          </div>

          <!-- bookings calendar/table -->
          <div class="card">
            <div class="section-title" id="ui_bookings">My Bookings / Schedule</div>
            <div style="margin-top:8px; overflow:auto; max-height:320px">
              <table id="bookingsTable">
                <thead><tr><th>Student</th><th>Teacher</th><th>When</th><th>Duration</th><th>Status</th><th>Zoom</th><th>Attend</th></tr></thead>
                <tbody id="bookingsBody"></tbody>
              </table>
            </div>
          </div>

          <!-- monthly summary & teacher controls -->
          <div class="card" id="bottomPanel">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
              <div style="flex:1; min-width:220px">
                <div class="section-title" id="ui_summary">Monthly Summary</div>
                <div class="tiny muted">Attendances / Charges</div>
                <div style="margin-top:8px">
                  <div>Attended: <strong id="summary_attended">0</strong></div>
                  <div>Missed: <strong id="summary_missed">0</strong></div>
                  <div>Total due: <strong id="summary_total">0</strong></div>
                </div>
              </div>

              <div style="flex:1; min-width:260px">
                <div class="section-title" id="ui_teacher_ctrl">Teacher Controls (for teacher role)</div>
                <label>Set default hourly rate</label>
                <input id="teacherRate" type="text" placeholder="e.g. 30" />
                <label>Set weekly availability (example: Mon 09:00-12:00, Wed 15:00-18:00)</label>
                <input id="teacherAvailInput" type="text" placeholder="e.g. Mon:09-12,Wed:15-18" />
                <div class="mt8 flex">
                  <button id="saveTeacherSettings" class="btn">Save</button>
                  <button id="clearTeacherSettings" class="btn ghost">Clear</button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </main>
    </div>

    <footer>
      <div id="ui_footer">Built with ❤️ — Demo only. Data stored locally.</div>
    </footer>
  </div>

  <!-- ========== JavaScript: app logic (all front-end, uses localStorage) ========== -->
  <script>
  /**********************************************
   * Academy Scheduler - client-only demo
   * Features:
   * - Demo data for students/teachers
   * - Filter by grade & teacher gender
   * - Select teacher, view availability, pick slots
   * - Bookings stored in localStorage, Zoom links generated
   * - Attendance marking, monthly summary
   * - Language toggle (Arabic / English)
   ***********************************************/

  (function(){
    // ---------- TRANSLATIONS ----------
    const TEXT = {
      ar: {
        appTitle: "أكاديمية أستاذ أونلاين",
        appSub: "حجز دروس خصوصية بسهولة — تجربة تجريبية",
        filtersTitle: "معلومات الطالب و الفلاتر",
        label_grade: "الصف الدراسي / Year",
        label_gender: "تفضيل جنس المدرس",
        label_search: "بحث",
        label_status: "الحالة",
        teachers: "المدرسين المتاحين",
        notifications: "سجل الإشعارات",
        metric_students: "الطلاب",
        metric_bookings: "الحجوزات",
        metric_revenue: "الإيرادات",
        selected_teacher: "المدرس المختار",
        avail_title: "التوفر (اختر المواعيد)",
        bookings: "جدول الحصص",
        summary: "ملخص شهري",
        teacher_ctrl: "إعدادات المدرّس",
        save: "حفظ",
        clear: "مسح",
        bookSelected: "احجز المختار",
        confirmSelection: "تأكيد",
        loadingData: "Loading data..."
      },
      en: {
        appTitle: "Ustadh Online Academy",
        appSub: "Private lessons booking — Demo",
        filtersTitle: "Student info & Filters",
        label_grade: "Grade / Year",
        label_gender: "Preferred teacher gender",
        label_search: "Search",
        label_status: "Status",
        teachers: "Available Teachers",
        notifications: "Notifications Log",
        metric_students: "Students",
        metric_bookings: "Bookings",
        metric_revenue: "Revenue",
        selected_teacher: "Selected Teacher",
        avail_title: "Availability (pick slots)",
        bookings: "Bookings / Schedule",
        summary: "Monthly Summary",
        teacher_ctrl: "Teacher Controls",
        save: "Save",
        clear: "Clear",
        bookSelected: "Book Selected",
        confirmSelection: "Confirm",
        loadingData: "Loading data..."
      }
    };

    // Current language (defaults to Arabic)
    let LANG = localStorage.getItem('academy_lang') || 'ar';
    document.documentElement.lang = LANG === 'ar' ? 'ar' : 'en';
    // ---------- Demo data (initial) ----------
    const demoTeachers = [
      { id: 't1', name: 'Dr. Sarah Abdullah', gender:'female', subjects:['Math','Physics'], rating:4.9, reviews: ['Very patient','Great explanation'], rate:30, avail: 'Mon:09-12,Wed:15-18' },
      { id: 't2', name: 'Mohammed Hassan', gender:'male', subjects:['Chemistry'], rating:4.6, reviews:['Explains well'], rate:25, avail: 'Tue:10-13,Thu:16-19' },
      { id: 't3', name: 'Aisha Al Saleh', gender:'female', subjects:['Biology','Chemistry'], rating:4.8, reviews:['Amazing'], rate:35, avail: 'Mon:14-17,Fri:09-12' },
      { id: 't4', name: 'Khalid Omar', gender:'male', subjects:['Math'], rating:4.4, reviews:['Good tutor'], rate:20, avail: 'Wed:09-11,Sat:10-13' },
    ];

    const demoStudents = [
      { id:'s1', name:'Ali bin Ahmed', grade:2, parent:'Parent A' },
      { id:'s2', name:'Sara bint Naim', grade:3, parent:'Parent B' }
    ];

    // localStorage keys
    const LS_KEYS = { TEACHERS:'academy_teachers', STUDENTS:'academy_students', BOOKINGS:'academy_bookings', NOTIFS:'academy_notifs' };

    // ---------- Utility helpers ----------
    const $ = id => document.getElementById(id);
    function uid(prefix='id'){ return prefix + Math.random().toString(36).slice(2,9); }
    function saveLS(key, data){ localStorage.setItem(key, JSON.stringify(data)); }
    function loadLS(key, fallback){ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
    function nowISO(){ return new Date().toISOString(); }
    function formatDate(d){
      const dt = new Date(d);
      return dt.toLocaleString(LANG==='ar' ? 'ar-EG' : 'en-US', { year:'numeric',month:'short',day:'numeric', hour:'2-digit',minute:'2-digit' });
    }

    // ---------- App state ----------
    let teachers = loadLS(LS_KEYS.TEACHERS, demoTeachers);
    let students = loadLS(LS_KEYS.STUDENTS, demoStudents);
    let bookings = loadLS(LS_KEYS.BOOKINGS, []);
    let notifs = loadLS(LS_KEYS.NOTIFS, []);
    let currentRole = 'student';
    let selectedTeacherId = null;
    let selectedSlots = []; // {teacherId, datetime, duration, slotId}

    // ---------- Rendering UI strings by LANG ----------
    function t(key){ return TEXT[LANG][key] || key; }
    function applyTexts(){
      $('ui_title').innerText = t('appTitle');
      $('ui_sub').innerText = t('appSub');
      $('ui_filters_title').innerText = t('filtersTitle');
      $('ui_label_grade').innerText = t('label_grade');
      $('ui_label_gender').innerText = t('label_gender');
      $('ui_label_search').innerText = t('label_search');
      $('ui_label_status').innerText = t('label_status');
      $('ui_teachers').innerText = t('teachers');
      $('ui_notifications').innerText = t('notifications');
      $('ui_metric_students').innerText = t('metric_students');
      $('ui_metric_bookings').innerText = t('metric_bookings');
      $('ui_metric_revenue').innerText = t('metric_revenue');
      $('ui_selected_teacher').innerText = t('selected_teacher');
      $('ui_avail_title').innerText = t('avail_title');
      $('ui_bookings').innerText = t('bookings');
      $('ui_summary').innerText = t('summary');
      $('ui_teacher_ctrl').innerText = t('teacher_ctrl');
      $('saveTeacherSettings').innerText = t('save');
      $('clearTeacherSettings').innerText = t('clear');
      $('bookBtn').innerText = t('bookSelected');
      $('confirmSlots').innerText = t('confirmSelection');
      $('demoFill').innerText = LANG==='ar' ? 'تحميل مثال' : 'Load Demo';
      $('exportBtn').innerText = LANG==='ar' ? 'تصدير البيانات' : 'Export Data';
    }

    // ---------- initialize UI ----------
    function initUI(){
      // lang buttons
      $('btn_ar').addEventListener('click', ()=> setLang('ar'));
      $('btn_en').addEventListener('click', ()=> setLang('en'));

      $('roleSelect').value = currentRole;
      $('roleSelect').addEventListener('change', e => { currentRole = e.target.value; renderAll(); });

      $('demoFill').addEventListener('click', ()=> {
        teachers = demoTeachers.slice(); students = demoStudents.slice(); bookings=[]; notifs=[];
        saveLS(LS_KEYS.TEACHERS, teachers); saveLS(LS_KEYS.STUDENTS, students); saveLS(LS_KEYS.BOOKINGS, bookings); saveLS(LS_KEYS.NOTIFS, notifs);
        toast('Demo data loaded');
        renderAll();
      });

      $('exportBtn').addEventListener('click', ()=> {
        const dump = { teachers, students, bookings, notifs };
        const blob = new Blob([JSON.stringify(dump,null,2)],{type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'academy-data.json'; a.click();
      });

      $('applyFilters').addEventListener('click', ()=> renderTeachers());
      $('clearFilters').addEventListener('click', ()=> {
        $('gradeSelect').value='1'; $('genderPref').value=''; $('searchBox').value=''; $('statusFilter').value='';
        renderTeachers();
      });

      $('bookBtn').addEventListener('click', onBookSelected);
      $('confirmSlots').addEventListener('click', confirmSlots);

      $('saveTeacherSettings').addEventListener('click', saveTeacherSettings);
      $('clearTeacherSettings').addEventListener('click', ()=> {
        $('teacherRate').value=''; $('teacherAvailInput').value=''; toast('Cleared');
      });

      // event bindings for filters to update live
      $('searchBox').addEventListener('input', ()=> renderTeachers());
      $('statusFilter').addEventListener('change', ()=> renderTeachers());
      $('genderPref').addEventListener('change', ()=> renderTeachers());
      $('gradeSelect').addEventListener('change', ()=> renderTeachers());
    }

    // ---------- language handling ----------
    function setLang(lang){
      LANG = lang; localStorage.setItem('academy_lang', lang);
      document.documentElement.lang = lang === 'ar' ? 'ar' : 'en';
      applyTexts();
      renderAll();
    }

    // ---------- notifications (simulated) ----------
    function pushNotif(text){
      const item = { id: uid('n'), text, time: nowISO() };
      notifs.unshift(item);
      notifs = notifs.slice(0,200);
      saveLS(LS_KEYS.NOTIFS, notifs);
      renderNotifs();
    }
    function renderNotifs(){
      const el = $('notifLog'); el.innerHTML='';
      notifs.forEach(n => {
        const d = document.createElement('div'); d.innerHTML = `<div style="margin-bottom:8px"><strong>${formatDate(n.time)}</strong><div class="tiny muted">${n.text}</div></div>`;
        el.appendChild(d);
      });
    }

    // ---------- teachers list rendering ----------
    function renderTeachers(){
      const container = $('teachersList'); container.innerHTML='';
      const grade = $('gradeSelect').value;
      const q = ($('searchBox').value||'').toLowerCase();
      const gender = $('genderPref').value;
      const status = $('statusFilter').value;

      // simple filter: by gender & search
      const list = teachers.filter(t => {
        if (gender && t.gender !== gender) return false;
        if (q && !(t.name.toLowerCase().includes(q) || (t.subjects||[]).join(' ').toLowerCase().includes(q))) return false;
        return true;
      });

      if (list.length===0){ container.innerHTML = `<div class="muted tiny center">No teachers found</div>`; return; }

      list.forEach(t => {
        const div = document.createElement('div'); div.className='teacher';
        div.innerHTML = `
          <div class="avatar">${t.name.split(' ').slice(0,1)[0].slice(0,1)}</div>
          <div class="t-info">
            <div class="t-name">${t.name}</div>
            <div class="t-meta tiny">${(t.subjects||[]).join(' • ')} • Rate: ${t.rate} • <span class="rating">${t.rating}</span></div>
            <div class="tiny muted">${t.reviews && t.reviews.length ? 'Reviews: ' + t.reviews.join(' | ') : ''}</div>
          </div>
          <div class="actions">
            <button class="btn selectTeacher" data-id="${t.id}">${LANG==='ar'?'اختيار':'Select'}</button>
          </div>
        `;
        container.appendChild(div);
      });

      // attach select handlers
      container.querySelectorAll('.selectTeacher').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          selectedTeacherId = e.target.getAttribute('data-id');
          selectedSlots = [];
          toast(LANG==='ar' ? 'تم اختيار المدرس' : 'Teacher selected');
          renderSelectedTeacher();
        });
      });
    }

    // ---------- selected teacher & availability ----------
    function renderSelectedTeacher(){
      const st = teachers.find(t=>t.id===selectedTeacherId);
      if (!st){
        $('selectedTeacherName').innerText = LANG==='ar' ? '—' : '—';
        $('selectedTeacherMeta').innerText = '';
        $('availabilityGrid').innerHTML = '<div class="tiny muted">No teacher selected</div>';
        return;
      }
      $('selectedTeacherName').innerText = st.name;
      $('selectedTeacherMeta').innerText = `${(st.subjects||[]).join(', ')} • ${st.rate} per hour • Rating ${st.rating}`;
      renderAvailabilityGrid(st);
    }

    // parse availability strings like Mon:09-12,Wed:15-18
    const WEEK = LANG==='ar' ? ['أحد','الإثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'] : ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    function parseAvail(avStr){
      const map = {};
      if (!avStr) return map;
      const parts = avStr.split(',');
      parts.forEach(p=>{
        const [dayPart,hrs] = p.split(':').map(s=>s.trim());
        if (!dayPart || !hrs) return;
        const day = dayPart.slice(0,3); // e.g. Mon
        const hh = hrs.split('-');
        const start = parseInt(hh[0],10); const end = parseInt(hh[1],10);
        map[day] = {start,end};
      });
      return map;
    }

    function renderAvailabilityGrid(teacher){
      const grid = $('availabilityGrid'); grid.innerHTML='';
      // we'll show next 7 days slots
      const now = new Date();
      for(let i=0;i<7;i++){
        const d = new Date(); d.setDate(now.getDate()+i);
        const dayName = d.toLocaleDateString(LANG==='ar' ? 'ar-EG' : 'en-US', {weekday:'short'});
        const container = document.createElement('div');
        container.style.gridColumn='auto';
        // header
        const header = document.createElement('div'); header.className='tiny center muted'; header.style.marginBottom='6px';
        header.innerHTML = `<div style="font-weight:700">${dayName}</div><div class="tiny">${d.toLocaleDateString()}</div>`;
        container.appendChild(header);
        // slots area (we will create 2-4 hourly slots)
        const slotsArea = document.createElement('div');
        slotsArea.style.display='grid'; slotsArea.style.gap='6px';
        // generate slots from teacher.avail for weekday match
        const availMap = parseAvail(teacher.avail||'');
        // dayKey may be like Mon or Tue -> get by en short weekday
        const dayKey = d.toLocaleDateString('en-US',{weekday:'short'}); // Mon,Tue...
        const a = availMap[dayKey];
        if (!a){
          const no = document.createElement('div'); no.className='tiny muted center'; no.innerText = LANG==='ar' ? 'غير متاح' : 'Not available';
          slotsArea.appendChild(no);
        } else {
          for(let h=a.start; h < a.end; h++){
            const slotTime = new Date(d); slotTime.setHours(h,0,0,0);
            const slotId = 'slot_'+teacher.id+'_'+slotTime.toISOString();
            const slotDiv = document.createElement('div');
            slotDiv.className = 'slot';
            // check if already booked
            const taken = bookings.some(b => b.teacherId===teacher.id && Math.abs(new Date(b.when) - slotTime) < 60*60*1000);
            if (taken) slotDiv.classList.add('taken');
            // display
            slotDiv.dataset.iso = slotTime.toISOString();
            slotDiv.id = slotId;
            slotDiv.innerText = `${h}:00 - ${h+1}:00`;
            if (!taken){
              slotDiv.addEventListener('click', ()=>{
                // toggle selected
                if (slotDiv.classList.contains('selected')){
                  slotDiv.classList.remove('selected');
                  selectedSlots = selectedSlots.filter(s => s.slotId !== slotId);
                } else {
                  slotDiv.classList.add('selected');
                  selectedSlots.push({ teacherId: teacher.id, when: slotTime.toISOString(), duration:60, slotId });
                }
              });
            }
            slotsArea.appendChild(slotDiv);
          }
        }
        container.appendChild(slotsArea);
        grid.appendChild(container);
      }
    }

    // ---------- booking flow ----------
    function onBookSelected(){
      if (!selectedTeacherId){ alert(LANG==='ar' ? 'اختر مدرساً أولا' : 'Select a teacher first'); return; }
      if (selectedSlots.length===0){ alert(LANG==='ar' ? 'اختر مواعيد' : 'Pick some slots first'); return; }
      // open confirm prompt (simple)
      const student = students[0] || { id:uid('s'), name:'Demo Student', grade:1 };
      // create bookings
      selectedSlots.forEach(sl=>{
        // double-check not clashing
        const exists = bookings.some(b => b.teacherId===sl.teacherId && Math.abs(new Date(b.when)-new Date(sl.when))<1000);
        if (exists) return;
        const booking = {
          id: uid('b'), studentId: student.id, studentName: student.name,
          teacherId: sl.teacherId, teacherName: (teachers.find(t=>t.id===sl.teacherId)||{}).name || '',
          when: sl.when, duration: sl.duration, status:'Scheduled', zoomLink: generateZoomLink(), attended:false,
          price: (teachers.find(t=>t.id===sl.teacherId)||{rate:0}).rate
        };
        bookings.push(booking);
        pushNotif(`${LANG==='ar' ? 'تم حجز حصة' : 'Booking created'} • ${booking.teacherName} • ${formatDate(booking.when)}`);
      });
      // persist
      saveLS(LS_KEYS.BOOKINGS, bookings);
      selectedSlots=[];
      renderSelectedTeacher(); renderBookings(); updateMetrics();
      toast(LANG==='ar' ? 'تم الحجز' : 'Booked');
    }

    function confirmSlots(){
      // same as book, but visible confirm
      onBookSelected();
    }

    function generateZoomLink(){
      // fake zoom link generator for demo
      const id = Math.floor(Math.random()*900000000)+100000000;
      return `https://zoom.us/j/${id}`;
    }

    // ---------- bookings table rendering and interactions ----------
    function renderBookings(){
      const tbody = $('bookingsBody'); tbody.innerHTML='';
      bookings.slice().reverse().forEach(b => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(b.studentName)}</td>
          <td>${escapeHtml(b.teacherName)}</td>
          <td>${formatDate(b.when)}</td>
          <td>${b.duration} min</td>
          <td><span class="badge ${b.status==='Completed'?'green':''}">${b.status}</span></td>
          <td><a href="${b.zoomLink}" target="_blank" class="tiny">${LANG==='ar'?'Join':'Join'}</a></td>
          <td>
            <button class="btn tiny attendBtn" data-id="${b.id}">${b.attended ? (LANG==='ar'?'حضر':'Present') : (LANG==='ar'?'تسجيل حضور':'Mark')}</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      // attach handlers
      document.querySelectorAll('.attendBtn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = e.target.dataset.id;
          const idx = bookings.findIndex(x=>x.id===id);
          if (idx>-1){
            bookings[idx].attended = !bookings[idx].attended;
            bookings[idx].status = bookings[idx].attended ? 'Completed' : 'Scheduled';
            saveLS(LS_KEYS.BOOKINGS, bookings);
            toast(LANG==='ar' ? 'تم تحديث الحضور' : 'Attendance updated');
            renderBookings(); updateSummary();
          }
        });
      });
    }

    // ---------- teacher settings ----------
    function saveTeacherSettings(){
      if (currentRole !== 'teacher'){ alert(LANG==='ar' ? 'الرجاء تسجيل الدخول كمدرس لحفظ الإعدادات' : 'Switch to teacher role to save settings'); return; }
      // for demo, we'll edit first teacher
      const t = teachers[0];
      const rate = $('teacherRate').value.trim();
      const avail = $('teacherAvailInput').value.trim();
      if (rate) t.rate = rate;
      if (avail) t.avail = avail;
      saveLS(LS_KEYS.TEACHERS, teachers);
      toast(LANG==='ar' ? 'Settings saved' : 'Saved');
      renderTeachers(); renderSelectedTeacher();
    }

    // ---------- metrics & summary ----------
    function updateMetrics(){
      $('metric_students').innerText = students.length;
      $('metric_bookings').innerText = bookings.length;
      const revenue = bookings.reduce((s,b)=> s + (b.price||0), 0);
      $('metric_revenue').innerText = revenue;
      updateSummary();
    }
    function updateSummary(){
      const thisMonth = (new Date()).getMonth();
      const mBookings = bookings.filter(b => new Date(b.when).getMonth()===thisMonth);
      const attended = mBookings.filter(b=>b.attended).length;
      const missed = mBookings.filter(b=>!b.attended && new Date(b.when) < new Date()).length;
      const total = mBookings.reduce((s,b)=> s + (b.price||0), 0);
      $('summary_attended').innerText = attended;
      $('summary_missed').innerText = missed;
      $('summary_total').innerText = total;
    }

    // ---------- rendering all ----------
    function renderAll(){
      applyTexts();
      renderTeachers();
      renderSelectedTeacher();
      renderBookings();
      renderNotifs();
      updateMetrics();
    }

    // ---------- small helpers ----------
    function toast(msg){
      pushNotif(msg);
      console.log('TOAST:',msg);
    }
    function escapeHtml(text){
      return (text||'').toString().replace(/[&<>"'`]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[s]));
    }

    // ---------- initialize app ----------
    initUI();
    setLang(LANG); // sets texts
    // ensure demo data persisted if empty
    if (!localStorage.getItem(LS_KEYS.TEACHERS)) saveLS(LS_KEYS.TEACHERS, teachers);
    if (!localStorage.getItem(LS_KEYS.STUDENTS)) saveLS(LS_KEYS.STUDENTS, students);
    if (!localStorage.getItem(LS_KEYS.BOOKINGS)) saveLS(LS_KEYS.BOOKINGS, bookings);
    if (!localStorage.getItem(LS_KEYS.NOTIFS)) saveLS(LS_KEYS.NOTIFS, notifs);

    renderAll();

    // auto-save on unload
    window.addEventListener('beforeunload', ()=> {
      saveLS(LS_KEYS.TEACHERS, teachers); saveLS(LS_KEYS.STUDENTS, students); saveLS(LS_KEYS.BOOKINGS, bookings); saveLS(LS_KEYS.NOTIFS, notifs);
    });

  })();
  </script>
</body>
</html>

